# Trading System Gap Analysis & Improvement Plan

**Created:** 2026-01-31  
**Status:** Planning  
**Purpose:** Address gaps identified in systematic codebase review

---

## Executive Summary

A comprehensive analysis of the codebase reveals a **well-architected** trading system with strong fundamentals in many areas, but with **critical gaps** in data collection depth, financial report integration into trading decisions, long-term simulation analysis, and advanced risk management. This plan identifies specific deficiencies and proposes phased improvements.

---

## Question-by-Question Assessment

### 1. Have we collected enough data both time series and cross-sectional?

**Answer: PARTIAL (70%)**

**‚úÖ What We Have:**
| Data Type | Implementation | Coverage |
|-----------|----------------|----------|
| OHLCV Time Series | HistoryDataService, MarketData entity | 10 years, multi-source (Shioaji, Yahoo, TWSE) |
| Index Data | IndexDataService, IndexData entity | TAIEX, TWOII, TW50 |
| Fundamental Data | FundamentalDataService, FundamentalData entity | Yahoo Finance metrics (P/E, P/B, ROE, etc.) |
| News Data | NewsService, EconomicNews entity | Multi-source with LLM sentiment |
| Economic Calendar | EconomicCalendarService, EconomicEvent entity | Taiwan market holidays, earnings dates |

**‚ùå What We're Missing:**
| Gap | Impact | Priority |
|-----|--------|----------|
| **Intraday tick data** | Cannot analyze microstructure, order flow | üü° HIGH |
| **Options/Derivatives data** | No implied volatility, put/call ratios | üü° HIGH |
| **Cross-sectional factor scores** | CrossSectionalMomentumStrategy operates on single-stock basis | üî¥ CRITICAL |
| **Sector/Industry groupings** | No sector rotation analysis | üü° HIGH |
| **Order book depth history** | OrderBookData exists but not historically persisted | üü¢ MEDIUM |
| **Analyst estimates history** | Only point-in-time, no historical revision tracking | üü¢ MEDIUM |

---

### 2. Have we collected and read financial reports before BUY/SELL?

**Answer: PARTIAL (60%)**

**‚úÖ What We Have:**
- `AnnualReportAnalysisJob.java` - Monthly scheduled job to download and index annual reports
- `FundamentalInsightService.java` - RAG queries against annual reports
- `FundamentalFilter.java` - Filters stocks based on P/E, debt-to-equity, revenue growth
- `annual_report_service.py` - TWSE annual report downloader
- `annual_report_rag_service.py` - FAISS-based RAG for report queries
- Integration in `AutoStrategySelector.java` (boosts strategies based on report insights)
- Integration in `OrderExecutionService.java` (fundamental filter check before trades)

**‚ùå Critical Gaps:**
| Gap | Current State | Impact |
|-----|---------------|--------|
| **Quarterly reports (10-Q equivalent)** | Not implemented | Missing 75% of financial updates |
| **Real-time earnings integration** | EarningsBlackoutService only prevents trades, doesn't analyze | Missed earnings surprise opportunities |
| **Balance sheet deep analysis** | Only surface metrics from Yahoo Finance | Poor debt quality assessment |
| **Cash flow statement analysis** | FCF available but not decomposed | Poor earnings quality detection |
| **Report freshness validation** | Monthly job only | Stale data during earnings season |

**Code Evidence:**
```java
// FundamentalFilter.java - Basic thresholds only
private static final double MAX_PE_RATIO = 50.0;
private static final double MAX_DEBT_TO_EQUITY = 2.0;
// No quarterly data, no earnings surprise analysis
```

---

### 3. Is our auto-selection mechanism based on enough statistical data and news?

**Answer: PARTIAL (65%)**

**‚úÖ What We Have:**
- `AutoStrategySelector.java` - Selects best strategy-stock combo based on backtest results
- `MarketRegimeService.java` - Regime detection (TRENDING_UP, DOWN, RANGING, HIGH_VOLATILITY, CRISIS)
- `RegimeStrategyMapper.java` - Maps strategies to optimal regimes
- `StrategyEvaluationService.java` - Statistical significance testing (t-test)
- `StrategyRankingService.java` - Ranks by Sharpe ratio
- `NewsService.java` - LLM sentiment scoring integrated
- `VetoAnalyticsService.java` - Tracks vetoed trades and hypothetical outcomes
- `TradeRiskScorer.java` - Multi-factor risk scoring

**‚ùå Gaps:**
| Gap | Impact | Priority |
|-----|--------|----------|
| **No walk-forward optimization in live selection** | WalkForwardService exists but not integrated with AutoStrategySelector | üî¥ CRITICAL |
| **News veto but no news-driven entry** | NewsSentimentStrategy exists but rarely selected as primary | üü° HIGH |
| **No macro indicator integration** | Fed rates, yield curve, PMI not considered | üü° HIGH |
| **No multi-stock correlation in selection** | Selects single best combo, ignores portfolio diversification | üî¥ CRITICAL |
| **No out-of-sample validation gate** | Selection based on in-sample backtest only | üî¥ CRITICAL |

---

### 4. Is our risk analysis robust enough?

**Answer: PARTIAL (55%)**

**‚úÖ What We Have:**
- `RiskManagementService.java` - Daily/weekly P&L tracking, loss limits, earnings blackout
- `DrawdownMonitorService.java` - Real-time drawdown monitoring
- `PositionSizingService.java` - Kelly criterion, ATR-based, risk parity sizing
- `VolatilityTargetingService.java` - Portfolio volatility targeting
- `CorrelationTracker.java` - Rolling correlation between positions
- `TradeRiskScorer.java` - Pre-trade risk scoring (0-100)
- `LlmService.java` - LLM-based paranoid risk veto
- Max drawdown limits (15% MDD)

**‚ùå Critical Gaps:**
| Gap | Current State | Impact |
|-----|---------------|--------|
| **No VaR/CVaR calculation** | Only max drawdown tracking | No probabilistic risk measure |
| **No stress testing** | No historical crash scenario analysis | Unprepared for tail events |
| **No sector exposure limits** | CorrelationTracker exists but no sector concentration limits | Concentrated sector risk |
| **No liquidity risk assessment** | Slippage model exists but no liquidity-based position limits | Execution risk in illiquid stocks |
| **No intraday risk limits** | Only daily/weekly aggregates | Flash crash vulnerability |
| **No margin call simulation** | Balance check exists but no margin scenario modeling | Forced liquidation risk |

**Code Evidence:**
```java
// RiskManagementService.java - Only basic loss limits
public boolean isDailyLimitExceeded(int dailyLossLimit) {
    return dailyPnL.get() <= -dailyLossLimit;
}
// No VaR, no stress test, no scenario analysis
```

---

### 5. Is our bank account checked before BUY/SELL even in simulation mode?

**Answer: YES (90%) ‚úÖ**

**‚úÖ Implementation Verified:**

```java
// TradingEngineService.java (line 337-345)
// üö® CRITICAL: Check account balance before placing BUY orders
if ("LONG".equals(direction)) {
    quantity = orderExecutionService.checkBalanceAndAdjustQuantity("BUY", quantity, currentPrice, instrument, tradingMode);
    if (quantity <= 0) {
        log.warn("‚ö†Ô∏è Insufficient balance for BUY order - skipping trade");
        telegramService.sendMessage("‚ö†Ô∏è Insufficient account balance - BUY order skipped");
        return;
    }
}
```

```java
// OrderExecutionService.java (line 59-80)
public int checkBalanceAndAdjustQuantity(String action, int requestedQuantity, double price, String instrument, String tradingMode) {
    // Checks API balance from Shioaji
    String accountJson = restTemplate.getForObject(getBridgeUrl() + "/account", String.class);
    double availableBalance = accountData.path("available_margin").asDouble(0.0);
    // Adjusts quantity if insufficient
}
```

**‚ö†Ô∏è Minor Gap:**
- In pure simulation (not connected to Shioaji), falls back to requested quantity if API fails
- Recommendation: Add a configurable "virtual balance" for offline simulation mode

---

### 6. In simulation mode, is enough data saved for analysis before going LIVE?

**Answer: PARTIAL (60%)**

**‚úÖ Data Being Saved:**
- `Trade` entity - All trades with entry/exit, P&L, strategy name, mode (SIMULATION/LIVE)
- `Signal` entity - All signals with confidence, direction, news score
- `Event` entity - All system events, API calls, errors
- `DailyStatistics` entity - Daily OHLCV aggregates, P&L, trade counts
- `StrategyPerformance` entity - Period-based performance metrics
- `VetoEvent` entity - All vetoed trades with hypothetical outcomes

**‚ùå Missing for Comprehensive Pre-Live Analysis:**
| Gap | What's Missing | Impact |
|-----|----------------|--------|
| **Execution quality metrics** | Fill rate, slippage per trade not persisted | Can't analyze execution improvement |
| **Market state at trade time** | No snapshot of market regime, volatility at trade entry | Can't correlate performance with conditions |
| **Alternative strategy signals** | Only active strategy's signals saved | Can't compare "what if different strategy" |
| **Order book state** | Not saved at trade execution time | Can't analyze market impact |
| **Position history timeline** | Only open/close, no intermediate P&L snapshots | Can't analyze intraday risk |

**Entities That Need Enhancement:**
```java
// Trade.java - Add these fields:
// - executedSlippage (actual vs expected)
// - marketRegimeAtEntry
// - volatilityAtEntry
// - orderBookSpreadAtEntry
// - alternativeSignals (JSON of other strategy signals)
```

---

### 7. Do we have analysis classes for 6-12 month simulation combined with backtesting and news?

**Answer: NO (30%) ‚ùå**

**Current State:**
- `StrategyPerformanceService.java` - Calculates metrics but doesn't combine sources
- `DataAnalysisService.java` - Basic P&L and signal metrics
- `StrategyEvaluationService.java` - Statistical significance but not multi-source
- `VetoAnalyticsService.java` - Tracks vetoed trades but standalone

**‚ùå Missing Comprehensive Analysis Classes:**

| Missing Class | Purpose | Priority |
|---------------|---------|----------|
| **`SimulationBacktestComparator`** | Compare live simulation vs historical backtest for same period | üî¥ CRITICAL |
| **`NewsImpactAnalyzer`** | Correlate news events with simulation trade outcomes | üî¥ CRITICAL |
| **`RegimePerformanceAnalyzer`** | Break down simulation results by market regime | üü° HIGH |
| **`StrategyDecayAnalyzer`** | Track strategy performance degradation over time | üü° HIGH |
| **`GoLiveReadinessReport`** | Comprehensive report combining all sources for live decision | üî¥ CRITICAL |
| **`SlippageRealityChecker`** | Compare simulated slippage vs backtest assumptions | üü° HIGH |

---

### 8. Do we lack any backend functionalities for automated trading?

**Answer: PARTIAL - Several Gaps Identified**

**‚úÖ Existing Capabilities:**
- Order execution with retry logic
- Position management
- Strategy rotation scheduler
- Earnings blackout enforcement
- LLM-based trade veto
- TWAP execution service
- Smart execution router
- Telegram command interface
- Dashboard REST APIs

**‚ùå Missing Backend Functionalities:**

| Missing Feature | Description | Priority |
|-----------------|-------------|----------|
| **Portfolio rebalancing engine** | Automatic periodic rebalancing to target weights | üî¥ CRITICAL |
| **Multi-asset allocation** | Only single-stock trading, no portfolio-level allocation | üî¥ CRITICAL |
| **Broker failover** | Single broker dependency (Shioaji) | üü° HIGH |
| **Order modification/cancellation** | No OCO, trailing stop, bracket orders | üü° HIGH |
| **Tax-loss harvesting** | No automated tax optimization | üü¢ MEDIUM |
| **Corporate action handler** | No dividends, splits, rights handling | üü° HIGH |
| **Compliance audit log** | Events exist but no regulatory-grade audit trail | üü¢ MEDIUM |
| **Real-time P&L streaming** | Polling-based, not WebSocket | üü¢ MEDIUM |
| **Multi-strategy concurrent execution** | One active strategy, shadow mode exists but limited | üü° HIGH |

---

## Phased Improvement Plan

### Phase 1: Critical Data & Analysis Gaps (Weeks 1-3)

**1.1 Cross-Sectional Data Service (Week 1)**
- [ ] Create `SectorUniverseService.java` - Sector/industry groupings for all Taiwan stocks
- [ ] Create `CrossSectionalFactorService.java` - Calculate factor scores across all stocks daily
- [ ] Add `SectorData` entity to persist sector classifications
- [ ] Integrate with `CrossSectionalMomentumStrategy` for true cross-sectional ranking

**1.2 Quarterly Report Integration (Week 2)**
- [ ] Create `quarterly_report_service.py` - Download quarterly reports from TWSE
- [ ] Create `QuarterlyReportMetadata` entity
- [ ] Add `QuarterlyReportAnalysisJob.java` - Quarterly scheduled analysis
- [ ] Enhance `FundamentalInsightService` to include quarterly data

**1.3 Simulation-Backtest Comparator (Week 3)**
- [ ] Create `SimulationBacktestComparator.java`
  - Compare live simulation trades vs backtested predictions
  - Calculate "reality gap" metrics
  - Track slippage deviation
  - Market regime correlation
- [ ] Create `GoLiveReadinessReport.java`
  - Aggregate 6-month simulation results
  - Compare with backtest expectations
  - Include news impact analysis
  - Generate human-readable recommendation

### Phase 2: Advanced Risk Management (Weeks 4-5)

**2.1 Probabilistic Risk Metrics (Week 4)**
- [ ] Create `ValueAtRiskService.java`
  - Historical VaR (95%, 99%)
  - Monte Carlo VaR
  - Expected Shortfall (CVaR)
- [ ] Create `StressTestService.java`
  - Historical crash scenarios (2008, 2020, 2022)
  - Custom scenario definition
  - Portfolio impact analysis

**2.2 Position & Sector Limits (Week 5)**
- [ ] Enhance `RiskManagementService.java`
  - Sector exposure limits (max 30% single sector)
  - Liquidity-based position limits
  - Intraday loss limits
- [ ] Create `MarginSimulationService.java`
  - Simulate margin calls
  - Forced liquidation scenarios

### Phase 3: Enhanced Trade Logging (Week 6)

**3.1 Enrich Trade Entity**
- [ ] Add to `Trade.java`:
  ```java
  private Double executedSlippage;
  private String marketRegimeAtEntry;
  private Double volatilityAtEntry;
  private Double orderBookSpreadAtEntry;
  private String alternativeSignalsJson;
  private Double expectedPnl;
  private String newsContextJson;
  ```

**3.2 Trade Context Service**
- [ ] Create `TradeContextService.java`
  - Capture market state at trade time
  - Store alternative strategy signals
  - Record news context

### Phase 4: Portfolio-Level Features (Weeks 7-8)

**4.1 Portfolio Allocation Engine (Week 7)**
- [ ] Create `PortfolioAllocationService.java`
  - Multi-stock position management
  - Target weight allocation
  - Correlation-aware diversification
- [ ] Create `RebalancingScheduler.java`
  - Periodic rebalancing triggers
  - Threshold-based rebalancing

**4.2 Multi-Strategy Execution (Week 8)**
- [ ] Enhance `StrategyManager.java`
  - Concurrent multi-strategy execution
  - Strategy capital allocation
  - Conflict resolution for opposing signals

### Phase 5: Operational Robustness (Week 9)

**5.1 Corporate Action Handler**
- [ ] Create `CorporateActionService.java`
  - Dividend adjustments
  - Stock split handling
  - Rights issue processing

**5.2 Order Management Enhancement**
- [ ] Create `AdvancedOrderService.java`
  - OCO (One-Cancels-Other)
  - Trailing stop orders
  - Bracket orders

---

## Implementation Priority Matrix

| Phase | Component | Effort | Impact | Priority |
|-------|-----------|--------|--------|----------|
| 1.1 | Cross-Sectional Data | Medium | Critical | üî¥ P1 |
| 1.2 | Quarterly Reports | Medium | High | üî¥ P1 |
| 1.3 | Simulation Comparator | High | Critical | üî¥ P1 |
| 2.1 | VaR/Stress Testing | High | Critical | üî¥ P1 |
| 2.2 | Sector/Position Limits | Medium | High | üü° P2 |
| 3.1 | Trade Entity Enhancement | Low | High | üü° P2 |
| 3.2 | Trade Context Service | Medium | High | üü° P2 |
| 4.1 | Portfolio Allocation | High | Critical | üü° P2 |
| 4.2 | Multi-Strategy | High | Medium | üü¢ P3 |
| 5.1 | Corporate Actions | Medium | Medium | üü¢ P3 |
| 5.2 | Advanced Orders | Medium | Medium | üü¢ P3 |

---

## Success Metrics

| Metric | Current | Target | Measurement |
|--------|---------|--------|-------------|
| Data Coverage (types) | 5/10 | 8/10 | Weekly audit |
| Financial Report Integration | Annual only | Annual + Quarterly | Per report cycle |
| Risk Metrics | Max DD only | VaR + CVaR + Stress | Real-time |
| Simulation Analysis Classes | 3 | 8+ | Code review |
| Pre-Live Analysis Depth | Basic P&L | Multi-source correlation | Go-live report |
| Strategy Selection OOS Validation | None | 80% OOS ratio | Weekly |

---

## Dependencies & Prerequisites

1. **Phase 1** can start immediately - no blockers
2. **Phase 2** requires Phase 1.3 for historical data alignment
3. **Phase 3** requires database migration for new columns
4. **Phase 4** requires Phase 2 for risk-aware allocation
5. **Phase 5** requires Phase 4 for multi-position management

---

## Risk Considerations

1. **Data quality** - Cross-sectional data from Yahoo Finance may have gaps
2. **Complexity** - Multi-strategy execution increases debugging difficulty
3. **Performance** - Real-time VaR calculations may impact latency
4. **Testing** - Each new service needs comprehensive unit + integration tests

---

## Quick Wins (This Week)

1. ‚úÖ Add `marketRegimeAtEntry` field to Trade entity (1 hour)
2. ‚úÖ Create basic `SectorService` mapping GICS sectors for Taiwan stocks (2 hours)
3. ‚úÖ Add historical VaR calculation to `DrawdownMonitorService` (4 hours)
4. ‚úÖ Create `GoLiveReadinessReport` shell with TODO markers (2 hours)

---

## References

- [plan0130.md](plan0130.md) - Previous improvement plan (Phase 5-9 items completed)
- [plan0126.md](plan0126.md) - Initial data improvement plan

---

## Change Log

| Date | Change |
|------|--------|
| 2026-01-31 | Initial gap analysis and phased plan created |
