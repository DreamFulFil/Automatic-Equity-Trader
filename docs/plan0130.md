# Trading System Improvement Plan

**Created:** 2026-01-30  
**Goal:** Identify gaps and improvements to make the trading system profitable  
**Status:** Planning

---

## Executive Summary

After comprehensive analysis of the Java + Python trading application, this document identifies **critical gaps** that likely prevent consistent profitability and proposes actionable improvements. The system has strong fundamentals (102 strategies, risk management, backtesting) but lacks **adaptive optimization, realistic execution modeling, and ML-driven decision making**.

---

## Current System Assessment

### âœ… Strengths
| Component | Status | Quality |
|-----------|--------|---------|
| Strategy Library | 102 strategies | Good diversity |
| Risk Management | 15% MDD, daily/weekly limits | Conservative |
| Backtesting | Virtual threads, bulk insert | High performance |
| Data Infrastructure | OHLCV, fundamentals, news, index | Recently improved |
| LLM Trade Veto | Paranoid risk manager | Very conservative |
| Taiwan Market Integration | Shioaji, TWSE | Complete |

### âŒ Critical Gaps Preventing Profitability
| Gap | Impact | Priority |
|-----|--------|----------|
| No Walk-Forward Optimization | Overfitting to historical data | ðŸ”´ CRITICAL |
| Static Strategy Parameters | Cannot adapt to regime changes | ðŸ”´ CRITICAL |
| Naive Position Sizing | Not risk-adjusted (Kelly, volatility-based) | ðŸ”´ CRITICAL |
| No Market Regime Detection | Wrong strategy in wrong conditions | ðŸ”´ CRITICAL |
| Unrealistic Slippage Model | 0.05% is optimistic for odd lots | ðŸŸ¡ HIGH |
| No Strategy Correlation Analysis | Concentrated risk | ðŸŸ¡ HIGH |
| Missing Execution Analytics | No fill rate, spread analysis | ðŸŸ¡ HIGH |
| Overly Conservative LLM Veto | May reject profitable trades | ðŸŸ¡ HIGH |
| No Annual Report Integration | New RAG service unused | ðŸŸ¢ MEDIUM |

---

## Phase 1: Walk-Forward Optimization Framework (CRITICAL)

### Problem
The current backtest system tests strategies on the **same data used to develop them**, leading to overfitting. A strategy showing 50% annual return in backtest may lose money live.

### Solution: Walk-Forward Testing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Training 1  â”‚   Test 1     â”‚  Training 2  â”‚   Test 2     â”‚
â”‚  (Optimize)  â”‚   (Verify)   â”‚  (Optimize)  â”‚   (Verify)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     60 days      20 days        60 days        20 days
```

### Implementation Checklist

- [ ] **1.1 Create WalkForwardService.java**
  - [ ] Sliding window with configurable train/test ratio (3:1 default)
  - [ ] Minimum 20 trading days per test window
  - [ ] Parameter optimization using grid search
  - [ ] Track out-of-sample vs in-sample performance ratio

- [ ] **1.2 Create ParameterOptimizer.java**
  - [ ] Define parameter ranges for each strategy
  - [ ] Multi-objective optimization (Sharpe + Sortino + Calmar)
  - [ ] Avoid over-optimization (max 3-5 parameters)
  - [ ] Implement Bayesian optimization (optional, more efficient)

- [ ] **1.3 Create OverfittingDetector.java**
  - [ ] Calculate IS/OOS (in-sample/out-of-sample) ratio
  - [ ] Flag strategies with IS/OOS ratio > 2.0
  - [ ] Track parameter stability across walk-forward windows
  - [ ] Reject strategies with high parameter drift

- [ ] **1.4 Add Robustness Tests**
  - [ ] Monte Carlo permutation tests
  - [ ] Bootstrap confidence intervals
  - [ ] Multiple random seeds for signal generation

### Expected Impact
- **Reduce overfitting by 60-80%**
- **Improve live-to-backtest performance ratio from ~50% to ~80%**

---

## Phase 2: Dynamic Position Sizing (CRITICAL)

### Problem
Current system uses **static share counts** (base + increment per equity level). This ignores:
- Per-trade risk (volatility)
- Kelly criterion for optimal growth
- Correlation between positions

### Current Implementation (Insufficient)
```java
// StockSettingsService.java
int additionalShares = (int) ((equity - FALLBACK_BASE_CAPITAL) / FALLBACK_INCREMENT_CAPITAL) * increment;
int totalShares = baseShares + additionalShares;
```

### Solution: Risk-Parity Position Sizing

### Implementation Checklist

- [ ] **2.1 Create PositionSizingService.java**
  - [ ] Kelly Criterion: `f* = (bp - q) / b` where `b`=odds, `p`=win rate, `q`=loss rate
  - [ ] Half-Kelly for conservative sizing
  - [ ] ATR-based position sizing: `shares = risk_per_trade / (ATR * multiplier)`
  - [ ] Max position = 10% of equity (hard cap)

- [ ] **2.2 Create VolatilityTargetingService.java**
  - [ ] Target portfolio volatility (e.g., 15% annualized)
  - [ ] Scale positions inversely to recent volatility
  - [ ] Use 20-day rolling volatility

- [ ] **2.3 Update RiskManagementService.java**
  - [ ] Integrate position sizing recommendations
  - [ ] Reject trades exceeding position limits
  - [ ] Track position concentration (no single stock > 25%)

- [ ] **2.4 Create CorrelationTracker.java**
  - [ ] Track rolling correlation between active positions
  - [ ] Reduce new positions when portfolio correlation > 0.7
  - [ ] Alert on concentrated sector exposure

### Expected Impact
- **Reduce max drawdown by 20-30%**
- **Improve risk-adjusted returns (Sharpe) by 15-25%**

---

## Phase 3: Market Regime Detection (CRITICAL)

### Problem
Momentum strategies work in trending markets, mean reversion in ranging markets. The system has no regime awarenessâ€”it runs the same strategy regardless of market conditions.

### Solution: Regime Classification + Strategy Rotation

### Implementation Checklist

- [ ] **3.1 Create MarketRegimeService.java**
  - [ ] Define regimes: TRENDING_UP, TRENDING_DOWN, RANGING, HIGH_VOLATILITY, CRISIS
  - [ ] Use multiple indicators:
    - ADX > 25 = Trending
    - VIX equivalent > 30 = High Volatility
    - MA50 vs MA200 slope = Bull/Bear
  - [ ] Bayesian regime switching model (optional)

- [ ] **3.2 Create RegimeStrategyMapper.java**
  - [ ] Map strategies to optimal regimes
  ```java
  TRENDING_UP â†’ MomentumStrategy, BreakoutStrategy
  RANGING â†’ MeanReversionStrategy, BollingerBandStrategy
  HIGH_VOLATILITY â†’ ReduceExposure, CashPreservation
  CRISIS â†’ ExitAll, DefensiveOnly
  ```
  - [ ] Weight strategies by regime confidence

- [ ] **3.3 Create RegimeTransitionService.java**
  - [ ] Detect regime transitions (not just current state)
  - [ ] Gradual position scaling during transitions
  - [ ] Avoid whipsaw on false transitions (require 3-day confirmation)

- [ ] **3.4 Update AutoStrategySelector.java**
  - [ ] Consider regime in strategy selection
  - [ ] Don't switch to momentum strategy in ranging market
  - [ ] Reduce position sizes during regime uncertainty

### Expected Impact
- **Avoid 30-50% of losing trades caused by wrong strategy-market fit**
- **Improve win rate by 10-15%**

---

## Phase 4: Realistic Execution Modeling (HIGH)

### Problem
Backtest uses fixed 0.05% slippage, but Taiwan odd-lot trading has:
- Wider bid-ask spreads (0.1-0.5%)
- Lower liquidity (partial fills)
- Market impact for larger orders

### Current Implementation
```java
private static final double SLIPPAGE_RATE = 0.0005;  // 0.05% - TOO OPTIMISTIC
```

### Solution: Adaptive Slippage + Execution Analytics

### Implementation Checklist

- [ ] **4.1 Create ExecutionAnalyticsService.java**
  - [ ] Track actual fill prices vs decision prices
  - [ ] Calculate realized slippage per stock, per time-of-day
  - [ ] Identify high-slippage periods (open/close)

- [ ] **4.2 Create AdaptiveSlippageModel.java**
  - [ ] Volume-dependent slippage: higher for low-volume stocks
  - [ ] Time-dependent: higher at open/close
  - [ ] Order size impact: larger orders = more slippage
  - [ ] Formula: `slippage = base + (size/ADV) * impact_factor`

- [ ] **4.3 Update BacktestService.java**
  - [ ] Replace fixed slippage with adaptive model
  - [ ] Add partial fill simulation
  - [ ] Track "execution cost" separate from strategy P&L

- [ ] **4.4 Create ExecutionQualityReport.java**
  - [ ] Weekly report: slippage, fill rate, spread analysis
  - [ ] Identify problematic stocks (high slippage)
  - [ ] Telegram notification for execution issues

### Expected Impact
- **More accurate backtest results (reduce live disappointment)**
- **Identify stocks to avoid due to execution costs**

---

## Phase 5: Enhance LLM Trade Veto System (HIGH)

### Problem
Current veto system is **extremely conservative** (defaults to VETO). While good for capital preservation, it may reject profitable trades.

### Current Rules (Too Strict)
```python
4. Fewer than 3 trades executed today â†’ if more, VETO.
5. No recent losing streak (2+ consecutive losses) â†’ VETO.
6. Trade size is 100 shares or fewer â†’ if more, VETO.
```

### Solution: Calibrated Risk Scoring

### Implementation Checklist

- [x] **5.1 Create TradeRiskScorer.java**
  - [x] Calculate risk score 0-100 for each trade proposal
  - [x] Weight factors: drawdown (30%), news (20%), volatility (20%), streak (15%), size (15%)
  - [x] VETO only if risk_score > 70 (instead of any single factor)

- [x] **5.2 Update ollama_service.py Prompt**
  - [x] Change from binary APPROVE/VETO to risk score
  - [x] Add context about expected value of trade
  - [x] Allow higher risk for high-conviction signals

- [x] **5.3 Create VetoAnalyticsService.java**
  - [x] Track vetoed trades and their hypothetical outcomes
  - [x] Calculate "missed profit" from false vetoes
  - [x] Tune veto thresholds based on historical data

- [x] **5.4 Add Trade Confidence from Strategy**
  - [x] Pass strategy's signal confidence to veto system
  - [x] High-confidence signals (>0.9) get relaxed veto criteria
  - [x] Low-confidence signals (<0.5) get stricter veto

### Expected Impact
- **Reduce false vetoes by 30-40%**
- **Capture more profitable opportunities**

---

## Phase 6: Strategy Performance Culling (HIGH)

### Problem
102 strategies create noise. Many may have negative expected value after transaction costs.

### Solution: Continuous Performance Evaluation

### Implementation Checklist

- [x] **6.1 Create StrategyEvaluationService.java**
  - [x] Calculate live Sharpe ratio (not just backtest)
  - [x] Require minimum 30 trades before evaluation
  - [x] Statistical significance test for positive returns

- [x] **6.2 Create StrategyRankingService.java**
  - [x] Rank strategies by risk-adjusted returns
  - [x] Top 10-20 strategies for live trading
  - [x] Bottom 20% moved to paper trading only

- [x] **6.3 Create StrategyRotationScheduler.java**
  - [x] Monthly strategy review
  - [x] Promote paper-only strategies if performance improves
  - [x] Demote live strategies if performance degrades
  - [x] Maximum 5 strategies active simultaneously

- [x] **6.4 Add Strategy Lifecycle**
  ```
  CANDIDATE â†’ PAPER_TRADING â†’ SHADOW_MODE â†’ LIVE â†’ RETIRED
  ```
  - [x] Automated promotion/demotion based on metrics
  - [x] Require 60 days paper trading before live

### Expected Impact
- **Focus capital on proven strategies**
- **Reduce transaction costs from low-quality signals**

---

## Phase 7: Annual Report RAG Integration (MEDIUM)

### Problem
New services created (`annual_report_service.py`, `annual_report_rag_service.py`, `annual_report_summary_service.py`) are not integrated into trading decisions.

### Solution: Fundamental Analysis Pipeline

### Implementation Checklist

- [x] **7.1 Create AnnualReportAnalysisJob.java**
  - [x] Scheduled job to download reports for watchlist stocks
  - [x] Index reports in FAISS via Python bridge
  - [x] Cache summaries in database

- [x] **7.2 Create FundamentalInsightService.java**
  - [x] Query RAG for specific questions:
    - "What are the main risks mentioned?"
    - "Revenue growth outlook?"
    - "Management discussion on market conditions?"
  - [x] Score stocks based on report sentiment

- [x] **7.3 Integrate with Strategy Selection**
  - [x] Boost strategies for stocks with positive report insights
  - [x] Reduce exposure for stocks with negative insights
  - [x] Add report-based scoring to AutoStrategySelector

- [x] **7.4 Add Fundamental Filters**
  - [x] Filter stocks with poor fundamentals (P/E > 50, debt > 2.0, negative revenue)
  - [x] Integrate FundamentalFilter into OrderExecutionService
  - [x] Block trades that fail fundamental thresholds

### Expected Impact
- **Better stock selection based on fundamentals**
- **Early warning for deteriorating fundamentals**

---

## Phase 8: Execution Optimization (MEDIUM)

### Problem
Orders are executed at market immediately. No smart order routing or timing optimization.

### Solution: TWAP/VWAP Execution

### Implementation Checklist

- [x] **8.1 Create TWAPExecutionService.java**
  - [x] Split large orders into smaller chunks
  - [x] Execute over 5-15 minute window
  - [x] Reduce market impact
  - [x] Calculate optimal chunk count and execution window based on order size and volatility

- [x] **8.2 Create OptimalExecutionTimer.java**
  - [x] Identify low-slippage periods from historical patterns
  - [x] Avoid execution during high-volatility moments (market open/close)
  - [x] Calculate execution priority scores (0-100)
  - [x] Recommend optimal timing for order execution

- [x] **8.3 Create FillAnalyticsService.java**
  - [x] Track fill rates per order type, per symbol
  - [x] Identify optimal order types (limit vs market)
  - [x] Analyze execution quality and slippage
  - [x] Provide order type recommendations based on historical performance

- [x] **8.4 Create SmartExecutionRouter.java**
  - [x] Route orders to optimal execution strategy
  - [x] Integrate TWAP, optimal timing, and fill analytics
  - [x] Provide execution strategy recommendations

### Expected Impact
- **Reduce execution costs by 10-20%**
- **Improve fill rates**
- **Better average execution prices through TWAP**
- **Avoid high-volatility execution windows**

---

## Phase 9: Real-Time Monitoring Dashboard (LOW)

### Problem
System monitoring relies on Telegram and logs. No visual dashboard for real-time P&L, positions, and strategy performance.

### Solution: Web Dashboard

### Implementation Checklist

- [x] **9.1 Create DashboardController.java**
  - [x] REST endpoints for dashboard data
  - [x] Real-time alert management
  - [x] Position summary API
  - [x] Strategy performance rankings
  - [x] Recent trade activity endpoint
  - [x] Equity curve data endpoint
  - [x] Risk metrics endpoint

- [x] **9.2 Create DashboardDataService.java**
  - [x] Aggregate data from TradeRepository, PositionManager
  - [x] Calculate P&L metrics (daily, weekly, monthly)
  - [x] Generate equity curve data points
  - [x] Compute risk metrics (Sharpe ratio, drawdown, win rate)

- [x] **9.3 Create AlertService.java**
  - [x] Centralized alert management
  - [x] Alert priority levels (CRITICAL, WARNING, INFO, LOW)
  - [x] Alert types (RISK, TRADE, SYSTEM, PERFORMANCE, STRATEGY)
  - [x] Telegram integration for critical alerts
  - [x] Alert history tracking
  - [x] Read/unread management
  - [x] Alert statistics and filtering

- [x] **9.4 Create React Dashboard**
  - [x] Live equity curve (30-day cumulative P&L)
  - [x] Position table with unrealized P&L
  - [x] Strategy performance comparison (top 10 by 30-day P&L)
  - [x] Risk metrics display (Sharpe ratio, drawdown, win rate)
  - [x] Real-time P&L overview (daily/weekly/monthly/total)
  - [x] Trade log viewer (recent 20 trades)
  - [x] Alert center with read/unread management
  - [x] Auto-refresh every 30 seconds
  - [x] Dark theme optimized for trading

### Expected Impact
- **Faster response to issues** âœ…
- **Better situational awareness** âœ…
- **Centralized notification system** âœ…
- **Real-time portfolio monitoring** âœ…

**Status:** âœ… **COMPLETE** (Backend API + React Dashboard)

**Dashboard Location:** `/dashboard`  
**Tech Stack:** React 18, Vite, Recharts, Axios  
**Features:** Overview metrics, equity curve chart, positions table, strategy rankings, recent trades, alert management  
**Access:** `npm run dev` at `http://localhost:3000` (proxies to backend at `http://localhost:8080`)

---

## Implementation Priority Matrix

| Phase | Effort | Impact | Priority | Timeline |
|-------|--------|--------|----------|----------|
| 1. Walk-Forward Optimization | High | Critical | ðŸ”´ P1 | 2 weeks |
| 2. Dynamic Position Sizing | Medium | Critical | ðŸ”´ P1 | 1 week |
| 3. Market Regime Detection | High | Critical | ðŸ”´ P1 | 2 weeks |
| 4. Realistic Execution Model | Medium | High | ðŸŸ¡ P2 | 1 week |
| 5. Enhanced LLM Veto | Low | High | ðŸŸ¡ P2 | 3 days |
| 6. Strategy Culling | Medium | High | ðŸŸ¡ P2 | 1 week |
| 7. Annual Report Integration | Medium | Medium | ðŸŸ¢ P3 | 1 week |
| 8. Execution Optimization | Medium | Medium | ðŸŸ¢ P3 | 1 week |
| 9. Dashboard | High | Low | âšª P4 | 2 weeks |

---

## Quick Wins (Can Do This Week)

1. **Increase slippage rate** in BacktestService from 0.05% to 0.15% for more realistic results
2. **Add strategy performance tracking** to database (live vs backtest comparison)
3. **Implement half-Kelly position sizing** as option in StockSettingsService
4. **Create regime indicator** (simple ADX + MA crossover) for manual review
5. **Add missed trade analysis** to veto system

---

## Success Metrics

| Metric | Current (Estimated) | Target | Measurement |
|--------|---------------------|--------|-------------|
| Live/Backtest Performance Ratio | ~50% | >80% | Monthly |
| Max Drawdown | ~15% | <12% | Real-time |
| Sharpe Ratio | ~0.5 | >1.0 | Quarterly |
| Win Rate | ~45% | >52% | Monthly |
| False Veto Rate | Unknown | <30% | Weekly |
| Execution Slippage | Unknown | <0.2% | Weekly |

---

## Risk Considerations

1. **Over-engineering risk**: Don't add complexity without clear value
2. **Data snooping**: Even walk-forward can overfit if run too many times
3. **Regime detection lag**: Markets change faster than detection
4. **Execution changes**: Broker behavior may change

---

## Next Steps

1. Start with **Phase 1 (Walk-Forward)** â€” foundation for all other improvements
2. Parallel work on **Phase 2 (Position Sizing)** â€” low dependency
3. Implement **Quick Wins** immediately for fast feedback
4. Review this plan weekly and adjust based on results

---

## References

- [Advances in Financial Machine Learning - Marcos LÃ³pez de Prado](https://www.wiley.com/en-us/Advances+in+Financial+Machine+Learning-p-9781119482086)
- [Evidence-Based Technical Analysis - David Aronson](https://www.wiley.com/en-us/Evidence+Based+Technical+Analysis-p-9780470008744)
- [Active Portfolio Management - Grinold & Kahn](https://www.mhprofessional.com/active-portfolio-management-9780070248823-usa)
- Taiwan Stock Exchange odd-lot trading rules

---

## Change Log

| Date | Change |
|------|--------|
| 2026-01-30 | Initial improvement plan created |
