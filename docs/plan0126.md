# Data Improvement Plan for Trading Strategies

**Created:** 2026-01-26  
**Status:** In Progress  
**Total Strategies:** 102 in `tw.gc.auto.equity.trader.strategy.impl`

---

## Executive Summary

Analysis of the codebase reveals that while OHLCV market data and technical indicators are well-supported, **~25 strategies** rely on price-based proxies instead of actual data they were academically designed to use. This plan addresses the data gaps in priority order.

---

## Current Data Inventory

| Data Type | Status | Source | Storage |
|-----------|--------|--------|---------|
| OHLCV Market Data | ✅ Complete | Shioaji | `market_data`, `bar` |
| Technical Indicators | ✅ Complete | Calculated | `MarketData` fields |
| Earnings Blackout Dates | ✅ Complete | yfinance | `earnings_blackout_date` |
| Trade History | ✅ Complete | Internal | `trade` |
| Fundamental Data | ❌ Missing | - | - |
| News/Sentiment | ❌ Missing | - | - |
| Index/Benchmark | ❌ Missing | - | - |
| Economic Calendar | ❌ Missing | - | - |

---

## Phase 1: Fundamental Data Integration

**Priority:** HIGH  
**Impact:** ~15 strategies  
**Estimated Effort:** 3-5 days

### Affected Strategies
- `EarningsYieldStrategy` - needs actual E/P ratios
- `BookToMarketStrategy` - needs book value data
- `DividendYieldStrategy` - needs dividend history
- `QualityMinusJunkStrategy` - needs ROE, ROA
- `ProfitabilityFactorStrategy` - needs gross profit margin
- `AccrualAnomalyStrategy` - needs accruals/cash flow
- `FinancialDistressStrategy` - needs debt ratios, Z-score inputs
- `CashFlowValueStrategy` - needs cash flow statements
- `GrahamDefensiveStrategy` - needs P/E, current ratio
- `EnterpriseValueMultipleStrategy` - needs EV/EBITDA
- `NetPayoutYieldStrategy` - needs dividend + buyback data
- `NetStockIssuanceStrategy` - needs share issuance history
- `AssetGrowthAnomalyStrategy` - needs total asset history
- `InvestmentFactorStrategy` - needs capex data
- `SalesGrowthValueStrategy` - needs revenue history

### Checklist

- [x] **1.1 Create FundamentalData Entity**
  - [x] Create `FundamentalData.java` in `entities/`
  - [x] Fields: symbol, timestamp, eps, pe_ratio, book_value, market_cap
  - [x] Fields: roe, roa, gross_margin, debt_to_equity
  - [x] Fields: dividend_yield, dividend_payout_ratio
  - [x] Fields: cash_flow_per_share, accruals_ratio
  - [x] Fields: total_assets, total_debt, revenue
  - [x] Add appropriate indexes

- [x] **1.2 Create FundamentalDataRepository**
  - [x] Create `FundamentalDataRepository.java` in `repositories/`
  - [x] Method: `findBySymbol(String symbol)`
  - [x] Method: `findLatestBySymbol(String symbol)`
  - [x] Method: `findBySymbolAndDateRange(String symbol, LocalDate start, LocalDate end)`

- [x] **1.3 Create FundamentalDataService**
  - [x] Create `FundamentalDataService.java` in `services/`
  - [x] Implement yfinance data fetching (Python bridge)
  - [ ] Alternative: TWSE OpenAPI integration
  - [x] Scheduled refresh: Daily after market close (14:00 Taiwan time)
  - [x] Error handling and retry logic

- [x] **1.4 Add Python Bridge Endpoint**
  - [x] Create `/api/fundamentals/{symbol}` endpoint in Python bridge
  - [x] Use yfinance `.info` and `.financials` data
  - [x] Return standardized JSON response

- [x] **1.5 Update Strategies (Priority Order)**
  - [x] Create `FundamentalDataProvider` interface for strategy injection
  - [x] Update `EarningsYieldStrategy` to use real E/P
  - [x] Update `BookToMarketStrategy` to use real B/M ratio
  - [x] Update `DividendYieldStrategy` to use real dividend data
  - [x] Update `QualityMinusJunkStrategy` to use real quality metrics
  - [x] Wire up provider in `BacktestService`
  - [ ] Update remaining fundamental strategies (CashFlowValue, GrahamDefensive, etc.)

- [x] **1.6 Testing**
  - [x] Unit tests for FundamentalDataService
  - [x] Unit tests for FundamentalData entity
  - [x] Unit tests for EarningsYieldStrategy fundamental integration
  - [x] Unit tests for BookToMarketStrategy fundamental integration
  - [x] Unit tests for QualityMinusJunkStrategy fundamental integration
  - [ ] Integration tests for Python bridge endpoint
  - [ ] Backtest comparison: proxy vs real data

---

## Phase 2: News & Sentiment Integration

**Priority:** MEDIUM  
**Impact:** ~3 strategies  
**Estimated Effort:** 2-3 days

### Affected Strategies
- `NewsSentimentStrategy` - currently returns "Neutral" always
- `NewsRevisionMomentumStrategy` - uses volume spikes as proxy

### Checklist

- [x] **2.1 Create EconomicNews Entity**
  - [x] Create `EconomicNews.java` in `entities/`
  - [x] Fields: id, timestamp, headline, source, url
  - [x] Fields: sentiment_score (-1.0 to +1.0), sentiment_confidence
  - [x] Fields: related_symbols (JSON string), category
  - [x] Fields: impact_level (HIGH/MEDIUM/LOW), is_breaking, is_processed
  - [x] Add appropriate indexes
  - [x] Utility methods: isBullish(), isBearish(), isConfident(), getAgeMinutes()

- [x] **2.2 Create EconomicNewsRepository**
  - [x] Create `EconomicNewsRepository.java` in `repositories/`
  - [x] Method: `findBySymbolAndDateRange()`
  - [x] Method: `findRecentBySymbol(String symbol, int hours)`
  - [x] Method: `findHighImpactNews(double minSentimentMagnitude)`
  - [x] Method: `calculateAverageSentiment()` - aggregation query
  - [x] Method: `findForMomentumCalculation()` - time-windowed sentiment
  - [x] Method: `existsByUrl()` - deduplication

- [x] **2.3 Create NewsService**
  - [x] Create `NewsService.java` in `services/`
  - [x] Implement news source integration via Python bridge:
    - [x] Yahoo Finance news (yfinance)
    - [x] Taiwan RSS feeds (MoneyDJ, UDN, CNYES)
  - [x] Integrate with LlmService for sentiment scoring
  - [x] Weighted sentiment with exponential decay (4hr half-life)
  - [x] Sentiment momentum calculation (recent vs older periods)
  - [x] Scheduled refresh: Every 30 minutes during market hours
  - [x] Breaking news detection and alerts

- [x] **2.4 Add Python Bridge Endpoints**
  - [x] Create `/api/news/{symbol}` endpoint for single stock
  - [x] Create `/api/news/batch` endpoint for multiple stocks
  - [x] Create `/api/news/market/tw` endpoint for Taiwan market news
  - [x] Create `news_service.py` with yfinance and feedparser

- [x] **2.5 Implement NewsSentimentStrategy Properly**
  - [x] Create `NewsSentimentProvider` functional interface
  - [x] Inject NewsService via provider pattern
  - [x] Aggregate sentiment scores per symbol with weighted decay
  - [x] Generate LONG signals on positive sentiment (>= threshold)
  - [x] Generate SHORT signals on negative sentiment (<= -threshold)
  - [x] Threshold lowering for HIGH_IMPACT news (0.7x)
  - [x] Breaking news detection

- [x] **2.6 Testing**
  - [x] Unit tests for NewsService (19 tests)
  - [x] Unit tests for NewsSentimentStrategy (17 tests)
  - [x] Unit tests for NewsSentimentProvider (25 tests)
  - [x] Unit tests for EconomicNews entity (27 tests)
  - [x] All 2,193 tests passing

---

## Phase 3: Index & Benchmark Data

**Priority:** MEDIUM  
**Impact:** ~6 strategies  
**Estimated Effort:** 2 days

### Affected Strategies
- `IndexArbitrageStrategy` - needs real TAIEX values
- `BasketArbitrageStrategy` - needs index component prices
- `BettingAgainstBetaStrategy` - needs market beta
- `MultiFactorRankingStrategy` - needs cross-sectional data
- `ResidualMomentumStrategy` - needs market model residuals
- `LowVolatilityAnomalyStrategy` - needs relative volatility ranking

### Checklist

- [x] **3.1 Create IndexData Entity** ✅ 2026-01-26
  - [x] Create `IndexData.java` in `entities/`
  - [x] Fields: indexSymbol, tradeDate, fetchedAt
  - [x] Fields: openValue, highValue, lowValue, closeValue, volume
  - [x] Fields: previousClose, changePercent, yearHigh, yearLow
  - [x] Fields: ma20, ma50, ma200, volatility20d, volatility60d
  - [x] Utility methods: getDailyReturn(), isBullMarket(), isAboveMa50(), isAboveMa200()
  - [x] Utility methods: hasGoldenCross(), hasDeathCross(), getYearRangePosition()

- [x] **3.2 Create IndexDataRepository** ✅ 2026-01-26
  - [x] Create `IndexDataRepository.java` in `repositories/`
  - [x] Method: `findFirstByIndexSymbolOrderByTradeDateDesc()`
  - [x] Method: `findBySymbolAndDateRange()`
  - [x] Method: `findRecentBySymbol()`
  - [x] Methods: `calculateAverageReturn()`, `calculateReturnStdDev()`

- [x] **3.3 Create IndexDataService** ✅ 2026-01-26
  - [x] Create `IndexDataService.java` in `services/`
  - [x] Fetch index data from Python bridge (yfinance)
  - [x] Support for TAIEX (^TWII), TWOII (^TWOII), TW50 (0050.TW)
  - [x] Methods: getLatest(), getCurrentValue(), getDailyReturn()
  - [x] Methods: getVolatility(), isBullMarket(), getMarketTrend()
  - [x] Scheduled refresh: Every 5 minutes during trading hours

- [x] **3.4 Create BetaCalculationService** ✅ 2026-01-26
  - [x] Create `BetaCalculationService.java` in `services/`
  - [x] Calculate rolling beta vs TAIEX (60-day window)
  - [x] Methods: getBeta(), getBetaResult(), getBetas()
  - [x] Methods: categorize(), findLowBetaStocks(), findHighBetaStocks()
  - [x] Methods: rankByBeta(), calculatePortfolioBeta()
  - [x] BetaResult record: beta, rSquared, alpha, volatility, trackingError
  - [x] Caching with 4-hour expiry
  - [x] Scheduled cache refresh: Daily at 14:00

- [x] **3.5 Create Provider Interfaces** ✅ 2026-01-26
  - [x] Create `IndexDataProvider.java` functional interface
  - [x] Factory methods: noOp(), withFixedValue(), withFixedData()
  - [x] Create `BetaProvider.java` functional interface
  - [x] Factory methods: noOp(), withFixedBeta(), fromMap(), withDefault()

- [x] **3.6 Add Python Bridge Endpoints** ✅ 2026-01-26
  - [x] Create `index_service.py` with yfinance integration
  - [x] GET `/api/index/{symbol}` - current index data
  - [x] GET `/api/index/{symbol}/history` - historical OHLCV
  - [x] GET `/api/index/{symbol}/returns` - daily returns for beta calc
  - [x] GET `/api/index/{symbol}/volatility` - annualized volatility
  - [x] POST `/api/index/batch` - multiple indices

- [x] **3.7 Update Strategies** ✅ 2026-01-26
  - [x] Update `IndexArbitrageStrategy` to use IndexDataProvider
  - [x] Updated confidence calculation (dynamic based on deviation)
  - [x] Adjusted threshold based on market trend
  - [x] Update `BettingAgainstBetaStrategy` to use BetaProvider
  - [x] Fallback to volatility-based proxy when real beta unavailable
  - [x] Updated confidence calculation (dynamic based on beta)

- [x] **3.8 Testing** ✅ 2026-01-26
  - [x] `IndexDataTest.java` - entity unit tests
  - [x] `IndexDataServiceTest.java` - service unit tests
  - [x] `BetaCalculationServiceTest.java` - beta calculation tests
  - [x] `IndexDataProviderTest.java` - interface tests
  - [x] `BetaProviderTest.java` - interface tests
  - [x] Updated `IndexArbitrageStrategyTest.java`
  - [x] Updated `BettingAgainstBetaStrategyTest.java`
  - [x] All 2,304 tests passing

---

## Phase 4: Economic Calendar Integration

**Priority:** LOW  
**Impact:** ~2 strategies  
**Estimated Effort:** 1-2 days

### Affected Strategies
- `SeasonalMomentumStrategy` - has basic month logic only
- `CalendarSpreadStrategy` - needs futures expiration calendar

### Checklist

- [x] **4.1 Create EconomicEvent Entity** ✅ 2026-01-26
  - [x] Create `EconomicEvent.java` in `entities/`
  - [x] Fields: event_type (enum: GDP, CPI, INTEREST_RATE, UNEMPLOYMENT, PMI, etc.)
  - [x] Fields: event_date, country, sector
  - [x] Fields: actual_value, forecast_value, previous_value
  - [x] Fields: impact_level (HIGH/MEDIUM/LOW), is_holiday
  - [x] Utility methods: getSurprise(), hasPositiveSurprise(), getSurpriseFactor()

- [x] **4.2 Create EconomicEventRepository** ✅ 2026-01-26
  - [x] Create `EconomicEventRepository.java` in `repositories/`
  - [x] Method: `findUpcomingEvents(int days)`
  - [x] Method: `findByCountryAndDateRange()`
  - [x] Method: `findHighImpactEvents(int days)`
  - [x] Method: `findByEventType()`
  - [x] Method: `countUpcomingByImpactLevel()`

- [x] **4.3 Create EconomicCalendarService + TaiwanMarketCalendar** ✅ 2026-01-26
  - [x] Create `EconomicCalendarService.java` in `services/`
  - [x] Create `TaiwanMarketCalendar.java` for Taiwan-specific dates
  - [x] Taiwan market hours: TWSE 09:00-13:30, TAIFEX 08:45-13:45
  - [x] Taiwan holidays: Lunar New Year, 228 Memorial, Tomb Sweeping, Labor Day, Dragon Boat, Moon Festival, National Day
  - [x] Futures expiration: Third Wednesday of each month
  - [x] Python bridge integration for economic events
  - [x] Scheduled refresh: Weekly on Sunday 00:00, daily at 05:00

- [x] **4.4 Create CalendarProvider Interface** ✅ 2026-01-26
  - [x] Create `CalendarProvider.java` functional interface
  - [x] Methods: getUpcomingEvents(), hasHighImpactEvent(), isMarketHoliday()
  - [x] Methods: isQuarterEnd(), getEventRisk(), getFuturesExpirationDate()
  - [x] Factory methods: noOp(), withFixedHolidays(), withFixedEvents(), withEventRisk()

- [x] **4.5 Add Python Bridge Endpoints** ✅ 2026-01-26
  - [x] Create `calendar_service.py` with Taiwan market calendar
  - [x] GET `/api/calendar/holidays/{year}` - Taiwan holidays for year
  - [x] GET `/api/calendar/holidays/upcoming` - upcoming holidays
  - [x] GET `/api/calendar/futures-expiration` - next futures expiration date
  - [x] GET `/api/calendar/economic-events` - upcoming economic events
  - [x] GET `/api/calendar/is-trading-day` - check if date is trading day

- [x] **4.6 Update Strategies** ✅ 2026-01-26
  - [x] Update `SeasonalMomentumStrategy` to use CalendarProvider
  - [x] Reduce confidence by event risk score before high-impact events
  - [x] Suggest reducing exposure instead of new positions before major events
  - [x] Taiwan-specific event awareness (Lunar New Year, holidays)
  - [x] Update `CalendarSpreadStrategy` to use CalendarProvider
  - [x] Consider futures expiration dates for volatility expectations
  - [x] Adjust strategy around expiration (increased volatility expected)

- [x] **4.7 Testing** ✅ 2026-01-26
  - [x] `EconomicEventTest.java` - entity unit tests (37 tests)
  - [x] `EconomicCalendarServiceTest.java` - service unit tests (26 tests)
  - [x] `TaiwanMarketCalendarTest.java` - Taiwan calendar tests (28 tests)
  - [x] `CalendarProviderTest.java` - provider interface tests (32 tests)
  - [x] Updated `SeasonalMomentumStrategyTest.java` (21 tests)
  - [x] Updated `CalendarSpreadStrategyTest.java` (7 tests)
  - [x] All 2,424 tests passing

---

## Phase 5: Order Book Enhancement (Optional)

**Priority:** LOW  
**Impact:** ~5 strategies  
**Estimated Effort:** 1-2 days

### Affected Strategies
- `LimitOrderBookStrategy`
- `OrderFlowImbalanceStrategy`
- `MarketMakingStrategy`
- `TradeVelocityStrategy`
- `BidAskSpreadStrategy`

### Checklist

- [ ] **5.1 Verify Shioaji L2 Data Availability**
  - [ ] Check if bid/ask/bid_volume/ask_volume are populated
  - [ ] Document which subscription level is needed

- [ ] **5.2 Enhance MarketData Population**
  - [ ] Ensure bid/ask fields are saved from Shioaji ticks
  - [ ] Add spread calculation field

- [ ] **5.3 Update Strategies**
  - [ ] Replace volume proxies with actual order book data
  - [ ] Improve signal accuracy

---

## Progress Tracking

### Overall Progress
- [x] Phase 1: Fundamental Data (6/6 tasks) - Entity, Repository, Service, Python Bridge, Strategy Updates, Tests ✅
- [x] Phase 2: News & Sentiment (6/6 tasks) - Entity, Repository, Service, Python Bridge, Strategy Updates, Tests ✅
- [x] Phase 3: Index & Benchmark (8/8 tasks) - Entity, Repository, Service, Beta Calc, Providers, Python Bridge, Strategy Updates, Tests ✅
- [x] Phase 4: Economic Calendar (7/7 tasks) - Entity, Repository, Service, TaiwanCalendar, Provider, Python Bridge, Strategy Updates, Tests ✅
- [ ] Phase 5: Order Book (0/3 tasks)

### Milestones
| Milestone | Target Date | Status |
|-----------|-------------|--------|
| Phase 1 Complete | 2026-01-26 | ✅ Done |
| Phase 2 Complete | 2026-01-26 | ✅ Done |
| Phase 3 Complete | 2026-01-26 | ✅ Done |
| Phase 4 Complete | 2026-01-26 | ✅ Done |
| Phase 5 Complete | TBD | ⬜ Not Started |
| All Phases Complete | TBD | ⬜ Not Started |

---

## Data Source Summary

| Data Type | Recommended Source | Cost | Reliability |
|-----------|-------------------|------|-------------|
| Fundamental | yfinance + TWSE API | Free | Medium |
| News | Google News RSS + Ollama | Free | Medium |
| Index | Shioaji (^TWII) | Included | High |
| Economic Calendar | Manual JSON + investing.com | Free | Medium |
| Order Book L2 | Shioaji | Included | High |

---

## Notes

- All new entities should follow existing patterns in `src/main/java/tw/gc/auto/equity/trader/entities/`
- All new services should be Spring `@Service` components
- Python bridge endpoints go in `python/app/`
- Follow existing testing patterns for unit tests
- Document any API rate limits encountered

---

## Change Log

| Date | Change |
|------|--------|
| 2026-01-26 | Initial plan created |
| 2026-01-26 | Phase 1.1-1.4 implemented: FundamentalData entity, repository, service, Python bridge |
| 2026-01-26 | Phase 1 Complete: All fundamental data tasks finished, strategy updates, unit tests |
| 2026-01-26 | Phase 2 Complete: EconomicNews entity, NewsService, Python bridge news endpoints, NewsSentimentProvider, strategy integration, 88 new tests |
| 2026-01-26 | Phase 3 Complete: IndexData entity, IndexDataService, BetaCalculationService, IndexDataProvider, BetaProvider, Python bridge index endpoints, strategy updates, 111 new tests (2,304 total) |
| 2026-01-26 | Phase 4 Complete: EconomicEvent entity, EconomicCalendarService, TaiwanMarketCalendar, CalendarProvider, Python bridge calendar endpoints, SeasonalMomentumStrategy and CalendarSpreadStrategy updates, 120 new tests (2,424 total) |

